import * as uiUtils from "./uiUtils.js"
import { DOM } from "./uiUtils.js"
import * as ws from "./ws.js"
// global variables
let pc; // PeerConnection object
let dataChannel;
let icecandidates = [];
const webRTCConfiguration = {
    iceServers:[
        {
            urls: [
                "stun:stun.l.google.com:19302",
                "stun:stun1.l.google.com:19302",
                "stun:stun2.l.google.com:19302",
                "stun:stun3.l.google.com:19302",
                "stun:stun4.l.google.com:19302",
            ],
        }
    ]
}

export function startWebrtcProcess(){
    let offer;
    uiUtils.LogToCustomConsole("Starting WebRTC process by clicking on the button", "green")
    DOM.offeror.offerorCreatePcButton.addEventListener("click", ()=>{
        createPeerConnectionObject()

        // ui update
        uiUtils.updateUiButton(DOM.offeror.offerorCreatePcButton, "Peer connection object created, now add data  channel")
        // addDataLogic();
    })
    DOM.offeror.offerorAddDataTypeButton.addEventListener("click", ()=>{
        //create our dataChannel
        createDataChannel(true);
        uiUtils.updateUiButton(DOM.offeror.offerorAddDataTypeButton, "Now create your WebRTC offer")
    })

    // creating offer
    DOM.offeror.offerorCreateOfferButton.addEventListener("click", async()=>{
        offer = await pc.createOffer()
        uiUtils.LogToCustomConsole("Succesfully created")
        console.log("Here's your offer", offer)
        uiUtils.updateUiButton(DOM.offeror.offerorCreateOfferButton, "You now have to update your local pc object with that offer")
    })

    DOM.offeror.offerorUpdateLocalDescriptionButton.addEventListener("click", async()=>{
        await pc.setLocalDescription(offer);
        uiUtils.updateUiButton(DOM.offeror.offerorUpdateLocalDescriptionButton, "You must not send your offer to other peer")
        console.log("Your pc object: after adding your offer to your pc object", pc)
        // ice candidates will now be gattered by the browser
    })

    DOM.offeror.offerorSendOfferButton.addEventListener("click", ()=>{
        ws.sendOffer(offer)
        uiUtils.updateUiButton(DOM.offeror.offerorSendOfferButton, "Offer is sent, Now wait for an answer .....");

    })
    
} // end of startWebrtcProcess

// search about sctp data channel, stcp bits and types
// data channels and how to use them + which type of data is needed for it
// RTCSCTPTransport object
function createDataChannel(isOfferor){
    if(isOfferor){
        // only need to create a data channel once, when offer is established
        // to mimic udp type transport on our data channel, set the ordered attribute to false, ans the maxretransmited to 0
        dataChannel = pc.createDataChannel("dataChannel", {
            ordered: false,
            maxRetransmits: 0,
        })
        // add an event listener to the data channel
        registerDataChannelEventListeners();
        uiUtils.LogToCustomConsole("Successfully created a data channel and added it to your pc object");
    } else {
        // if this else is executed, we are dealing with the oferree
        // the receiver needs to register a ondatachannel listener
        // this will only fire once a valid webrtc connection has been established

        pc.ondatachannel = (e) =>{
            dataChannel = e.channel;
            registerDataChannelEventListeners();
            uiUtils.LogToCustomConsole("SUccessfull registred the data channel it to your pc object")
        }
    }
}



function createPeerConnectionObject(){
    pc = new RTCPeerConnection(webRTCConfiguration)


    pc.addEventListener("connectionstatechange", ()=>{
        console.log("connectionstatechange", pc.connectionState)
        if(pc.connectionState === "connected"){
            alert("Connection established")
            uiUtils.LogToCustomConsole("Connection established", "green", true)
            // update ui to remove all the learning buttons, and allow users to insert text
        }
    })

    pc.addEventListener("signalingstatechange", ()=>{
        // console.log("signalingstatechange", pc.signalingState)
        // if(pc.signalingState === "stable"){
        //     alert("Signaling state stable")
        // }
        uiUtils.LogToCustomConsole("Signaling state stable", "orange", true)
    })

    // listening ice candidate generation
    pc.addEventListener("icecandidate", (e)=>{
        uiUtils.LogToCustomConsole("Ice candidate has been generated by the browser", "orange", true);
        if(e.candidate) {
            console.log("ICE:", e.candidate);
            icecandidates.push(e.candidate)
        }
    })


    return uiUtils.LogToCustomConsole("Peer connection object created", "green", true)
}

function registerDataChannelEventListeners(){
    dataChannel.addEventListener("message", (e)=>{
        console.log("message received", e.data)
        // later , ewe can implement logic to add the message to users frontend
    })
    dataChannel.addEventListener("open", (e)=>{
        console.log("data channel are open youre now ready to send/receive messages over your data channel")
    })
    dataChannel.addEventListener("close", (e)=>{
        console.log("Data channel has been closed")
    })
    dataChannel.addEventListener("error", (e)=>{})
}

export function handleOffer(data){
    uiUtils.LogToCustomConsole("WebRTC offer received, Create your peer connection object")
    uiUtils.showOffereeButtons();

    DOM.offeree.offereeCreatePcButton.addEventListener("click", ()=>{
        createPeerConnectionObject();
        uiUtils.updateUiButton(DOM.offeree.offereeCreatePcButton, "Next, register an event listener on your pc object, for a data channel ")
    });

    // steps 15 and 16
    DOM.offeree.offereeAddDataTypeButton.addEventListener("click", ()=>{
        createDataChannel(false); //4

        uiUtils.updateUiButton(DOM.offeree.offereeAddDataTypeButton, "Now you can update your pc object, by setting the remote description")
        console.log("====",pc)
    })
}